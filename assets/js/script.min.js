function formatMoney(number, places, symbol, thousand, decimal) {
    number = number || 0;
    places = !isNaN(places = Math.abs(places)) ? places : 0;
    symbol = symbol !== undefined ? symbol : "";
    thousand = thousand || ".";
    decimal = decimal || ",";
    var negative = number < 0 ? "-" : "",
    i = parseInt(number = Math.abs(+number || 0).toFixed(places), 10) + "",
    j = (j = i.length) > 3 ? j % 3 : 0;
    return symbol + negative + (j ? i.substr(0, j) + thousand : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + thousand) + (places ? decimal + Math.abs(number - i).toFixed(places).slice(2) : "")
}
function formatNumber(myElement) {
    var myVal = "",
    parts = myElement.value.toString().split("|");
    parts[0] = parts[0].replace(/[^0-9]/g, "");
    while (parts[0].length > 3) {
        myVal = "." + parts[0].substr(parts[0].length - 3, parts[0].length) + myVal;
        parts[0] = parts[0].substr(0, parts[0].length - 3)
    };
    myElement.value = parts[0] + myVal
}
function angka(number) {
    var number = number ? number : "",
    re = number.replace("Rp.", ""),
    res = replaceAll(".", "", re);
    return res
}
function replaceAll(find, replace, str) {
    while (str.indexOf(find) > -1)
        str = str.replace(find, replace);
    return str
}
function doMath() {
    var i = $("#tablein > tbody").children().length,
    njml = [],
    nharga = [],
    ndiskon = [],
    totharga = [],
    totdiskon = [],
    hargasdiskon = [],
    nUangMuka = 0,
    nUangMuka2 = 0,
    pajaksum = 0,
    sisa = 0,
    totsemua = 0,
    tot_uangmuka = 0,
    tpajak;
    nUangMuka = angka($("#uangmuka").val());
    pajaksum = angka($("#pajaksum").val());
    for (var a = 0; a < i; a++) {
        if ($("#jumlah_" + a).length == 0)
            continue;
        njml[a] = $("#jumlah_" + a.toString()).val();
        nharga[a] = $("#harga_" + a.toString()).val();
        ndiskon[a] = $("#diskon_" + a.toString()).val();
        totdiskon[a] = angka(nharga[a]) * ndiskon[a] / 100;
        hargasdiskon[a] = (angka(nharga[a])) - (totdiskon[a]);
        totharga[a] = angka(njml[a]) * hargasdiskon[a];
        document.getElementById("total_" + a.toString()).value = formatMoney(totharga[a], 0, "Rp.");
        totsemua += totharga[a]
    };
    tot_uangmuka = parseInt(nUangMuka2) + parseInt(angka(nUangMuka));
    tpajak = totsemua + ((totsemua * pajaksum) / 100);
    sisa = ((totsemua * pajaksum) / 100) + totsemua - angka(nUangMuka);
    document.getElementById("uangmuka").value = formatMoney(angka(nUangMuka), 0, "Rp.");
    document.getElementById("totalSum").value = formatMoney(tpajak, 0, "Rp.");
    document.getElementById("sisaSum").value = formatMoney(sisa, 0, "Rp.");
    document.getElementById("pajak").value = pajaksum;
    document.getElementById("sisabayar").value = formatMoney(totsemua, 0, "Rp.")
}
function doPengeluaran() {
    var i = $("#table_pengeluaran > tbody").children().length,
    njml = [],
    nharga = [],
    totharga = [],
    sisa = 0,
    totsemua = 0;
    for (var a = 0; a < i; a++) {
        if ($("#jum_" + a).length == 0)
            continue;
        njml[a] = document.getElementById("jum_" + a.toString()).value;
        nharga[a] = document.getElementById("pharga_" + a.toString()).value;
        totharga[a] = angka(njml[a]) * angka(nharga[a]);
        document.getElementById("ptotal_" + a.toString()).value = formatMoney(totharga[a], 0, "Rp.");
        totsemua += totharga[a]
    };
    document.getElementById("total_pengeluaran").value = formatMoney(totsemua, 0, "Rp.")
}
function formatRupiah(angka, prefix) {
    var number_string = angka.replace(/[^,\d]/g, '').toString(),
    split = number_string.split(','),
    sisa = split[0].length % 3,
    rupiah = split[0].substr(0, sisa),
    ribuan = split[0].substr(sisa).match(/\d{3}/gi);
    if (ribuan) {
        separator = sisa ? '.' : '';
        rupiah += separator + ribuan.join('.')
    };
    rupiah = split[1] != undefined ? rupiah + ',' + split[1] : rupiah;
    return prefix == undefined ? rupiah : (rupiah ? 'Rp. ' + rupiah : '')
}
function load_jenis_batal() {
    $.ajax({
        url: base_url + "pembayaran/jenis_pembayaran",
        type: 'GET',
        dataType: 'json',
        beforeSend: function () {
            $("#id_byrbatal").append("<option value='loading'>loading</option>");
            $("#id_byrbatal").empty()
        },
        success: function (response) {
            $("#id_byrbatal option[value='loading']").remove();
            $("#id_byrbatal").append("<option value=''>Pilih</option>");
            var len = response.length;
            for (var i = 0; i < len; i++) {
                var id = response[i]['id'],
                name = response[i]['name'];
                $("#id_byrbatal").append("<option value='" + id + "'>" + name + "</option>")
            }
        }
    })
};
$("#sumber_kas_batal").attr("disabled", true);
$("#rekening_bayar").attr("disabled", true);
$("#saldo_kas_batal").val("Rp.0");
$("#id_byrbatal").filter(function () {
    $('select[data-source]').each(function () {
        var $select = $(this);
        $select.append('<option value="0">Pilih</option>');
        $.ajax({
            url: $select.attr('data-source')
        }).then(function (options) {
            options.map(function (option) {
                var $option = $('<option>');
                $option.val(option[$select.attr('data-valueKey')]).text(option[$select.attr('data-displayKey')]);
                $select.append($option)
            })
        })
    })
});
$("#id_byrbatal").change(function () {
    var id = $("#id_byrbatal").val();
    $('#sumber_kas_batal').attr('disabled', false);
    $('.rekening').attr('disabled', true);
    $("#rekening_bayar").empty();
    if (id == 2) {
        $("#rekening_bayar").attr('required', true);
        $.ajax({
            url: base_url + "pembayaran/get_rekening",
            type: 'post',
            data: {
                type: 'cari'
            },
            dataType: 'json',
            success: function (response) {
                var len = response.length;
                $(".rekening").attr("disabled", false);
                $("#rekening_bayar").append("<option value=''>Pilih rekening</option>");
                for (var i = 0; i < len; i++) {
                    var id = response[i]['id'],
                    name = response[i]['name'];
                    $("#rekening_bayar").append("<option value='" + id + "'>" + name + "</option>")
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                sweet('Peringatan!!!', thrownError, 'warning', 'warning')
            }
        })
    } else if (id == 1) {
        $("#rekening_bayar").append("<option value=''>Pilih rekening</option>")
    } else
        $("#rekening_bayar").attr('required', false)
});
$("#id_byrbatal").change(function () {
    var id = $("#id_byrbatal").val();
    $('.sumber_kas_batal').attr('disabled', true);
    $('.jatuh_tempo').attr('disabled', true);
    $("#sumber_kas_batal").empty();
    $.ajax({
        url: base_url + "pengeluaran/jenis_kas",
        type: 'post',
        data: {
            id: id,
            type: 'cari'
        },
        dataType: 'json',
        success: function (response) {
            var len = response.length;
            $(".sumber_kas_batal").attr("disabled", false);
            $("#sumber_kas_batal").append("<option value=''>Pilih</option>");
            for (var i = 0; i < len; i++) {
                var id = response[i]['id'],
                name = response[i]['name'];
                $("#sumber_kas_batal").append("<option value='" + id + "'>" + name + "</option>")
            }
        },
        error: function (xhr, ajaxOptions, thrownError) {
            sweet('Peringatan!!!', thrownError, 'warning', 'warning')
        }
    });
    if (id == 3)
        $('.jatuh_tempo').attr('disabled', false)
});
$("#jenis_lembaga_edit").change(function () {
    var id = $("#jenis_lembaga_edit").val();
    if (id > 1) {
        $(".tampil_lembaga").show();
        $("#nama_perusahaan_edit").attr("required", false);
        $("#alamat_perusahaan_edit").attr("required", false);
        $("#no_telp_edit").attr("required", false)
    } else {
        $(".tampil_lembaga").hide();
        $("#nama_perusahaan_edit").attr("required", false);
        $("#alamat_perusahaan_edit").attr("required", false);
        $("#no_telp_edit").attr("required", false)
    }
});
$("#jenis_lembaga_add").change(function () {
    var id = $("#jenis_lembaga_add").val();
    if (id > 1) {
        $(".tampil_add").show();
        $("#perusahaan_add").attr("required", true);
        $("#alamat_perusahaan_add").attr("required", true);
        $("#no_telp_add").attr("required", true);
        $("#perusahaan_add").attr("data-mfindex", 6);
        $("#alamat_perusahaan_add").attr("data-mfindex", 7);
        $("#no_telp_add").attr("data-mfindex", 8);
        $("#tampil_data").attr("data-mfindex", 9);
        $("#via_add").attr("data-mfindex", 10);
        $("#status_add").attr("data-mfindex", 11);
        $("#max_u_add").attr("data-mfindex", 11)
    } else {
        $(".tampil_add").hide();
        $("#perusahaan_add").attr("required", false);
        $("#alamat_perusahaan_add").attr("required", false);
        $("#no_telp_add").attr("required", false);
        $("#perusahaan_add").attr("data-mfindex", '');
        $("#alamat_perusahaan_add").attr("data-mfindex", '');
        $("#no_telp_add").attr("data-mfindex", '');
        $("#tampil_data").attr("data-mfindex", '');
        $("#via_add").attr("data-mfindex", 6);
        $("#status_add").attr("data-mfindex", 7);
        $("#max_u_add").attr("data-mfindex", 8)
    }
});
$("#sumber_kas_batal").change(function () {
    var id = $("#sumber_kas_batal").val();
    $.ajax({
        url: base_url + "kas/total_kas",
        data: {
            id: id
        },
        dataType: "json",
        method: 'post',
        success: function (data) {
            $('#saldo_kas_batal').val(formatMoney(data, 0, "Rp."))
        },
        error: function (xhr, ajaxOptions, thrownError) {
            sweet('Peringatan!!!', thrownError, 'warning', 'warning')
        }
    })
});
$("#telepon_add").keyup(function (event) {
    var tlpadd = $("#telepon_add").val();
    tlpstart = tlpadd.trim();
    $("#telepon_add").val(tlpstart)
});
$(document).on('click', '.tambah2', function () {
    var dataID = $(this).attr('data-id');
    $('.tampil_add').hide();
    load_jenis_lembaga('add');
    if (dataID == 0) {
        $("#nama_add").val('');
        $("#panggilan_add").val('');
        $("#telepon_add").val('');
        $("#alamat_add").val('');
        $("#perusahaan_add").val('');
        $("#alamat_perusahaan_add").val('');
        $("#no_telp_add").val('');
        $("#status_add").val('0');
        $("#max_u_add").val('0');
        $("#via_add").val('build');
        $("#type_add").val('add_on_pelanggan')
    };
    $('#modal-tambah-1').modal({
        backdrop: 'static',
        keyboard: false
    });
    setTimeout(function () {
        $('#telepon_add').focus()
    }, 1e3)
})
function load_jenis_lembaga(jenis) {
    $('.tampil_lembaga').hide();
    $.ajax({
        url: base_url + "konsumen/jenis_lembaga",
        type: 'GET',
        dataType: 'json',
        beforeSend: function () {
            $("#jenis_lembaga_" + jenis).append("<option value='loading'>loading</option>");
            $("#jenis_lembaga_" + jenis).empty()
        },
        success: function (response) {
            if (response.status == 200) {
                $("#jenis_lembaga_" + jenis + " option[value='loading']").remove();
                $("#jenis_lembaga_" + jenis).append("<option value=''>Pilih</option>");
                var len = response.length;
                for (var i = 0; i < len; i++) {
                    var id = response[i]['id'],
                    name = response[i]['name'];
                    $("#jenis_lembaga_" + jenis).append("<option value='" + id + "'>" + name + "</option>")
                }
            }
        },
        error: function (xhr, ajaxOptions, thrownError) {
            sweet('Peringatan!!!', thrownError, 'warning', 'warning')
        }
    })
};
var isTimeout, isLoaded
function success() {
    if (isTimeout)
        return;
    $('#loading').hide();
    $('iframe').show();
    isLoaded = true
};
setTimeout(function () {
    if (isLoaded)
        return;
    $('#loading').hide();
    $('iframe').hide();
    $('#error').show();
    $('#error').css('display', 'flex');
    isTimeout = true
}, 1e5);
$("#telepon_add").change(function () {
    var idinvoice = $("#idnya").val();
    idinvoice = idinvoice ? idinvoice : 0;
    var telp = $('#telepon_add').val(),
    type_add = $('#type_add').val();
    if (telp.length <= 9) {
        $("#dispu").html("<img src='" + base_url + "assets/img/ajax-loader.gif' data-toggle='tooltip' title='cek data'/>")
    } else {
        $.ajax({
            url: base_url + "konsumen/cek_telp",
            data: {
                telp: telp,
                type_add: type_add
            },
            type: "POST",
            dataType: "json",
            success: function (respon) {
                if (respon[0] == 'ada') {
                    if (idinvoice > 0) {
                        $("#dispu").html("<a href='#' class='btn btn-info btn-sm cariada' data-toggle='tooltip' data-placement='left' title='No. Telp. sudah ada' data-idkon='" + respon.idnya + "' data-idin='" + idinvoice + "' data-idTelp='" + telp + "'><i class='fa fa-user-plus'></i></a><a href='#' class='btn btn-danger btn-sm clearada' data-toggle='tooltip' data-placement='left' title='Clear' onclick='resetForm()'><i class='fa fa-user-times'></i></a>")
                    } else
                        $("#dispu").html("<a href='#' class='btn btn-danger btn-sm clearada' data-toggle='tooltip' data-placement='left' title='Clear' onclick='resetForm()'><i class='fa fa-user-times'></i></a>");
                    $('#panggilan_add,#nama_add,#telepon_add,#alamat_add,#perusahaan_add,#jenis_lembaga_add,#alamat_perusahaan_add,#no_telp_add,#tampil_data,#via_add,#save-cari,#status_add,#max_u_add').prop('disabled', true);
                    if (respon.jenis > 1) {
                        $('.tampil_add').show()
                    } else
                        $('.tampil_add').hide();
                    $("#jenis_lembaga_add").val(respon.jenis);
                    $("#panggilan_add").val(respon.panggilan);
                    $("#nama_add").val(respon.nama);
                    $("#alamat_add").val(respon.alamat);
                    $("#perusahaan_add").val(respon.perusahaan);
                    $("#alamat_perusahaan_add").val(respon.alamat);
                    $("#no_telp_add").val(respon.perusahaan);
                    $("#via_add").val(respon.reff);
                    $('#errore').hide()
                } else if (respon.status == 400) {
                    sweet('Peringatan!!!', respon.msg, 'warning', 'warning');
                    $('#dispu').hide();
                    $("#telepon_add").val('')
                } else if (respon[0] == 'notelp') {
                    $("#errore").fadeIn(1e3, function () {
                        $("#errore").html('<div class="alert alert-warning"> <span class="glyphicon glyphicon-info-sign"></span>No. telp harus berawalan 08/628/+628</div>')
                    })
                } else {
                    $("#telepon_add").val(respon.msg);
                    $("#dispu").html("<button type='button' class='btn btn-success btn-sm takada' data-toggle='tooltip' data-placement='left' title='No. belum ada'><i class='fa fa-user'></i></button>");
                    $('#panggilan_add,#nama_add,#telepon_add,#alamat_add,#perusahaan_add,#jenis_lembaga_add,#alamat_perusahaan_add,#no_telp_add,#via,#save-cari,#status_add,#max_u_add').prop('disabled', false);
                    $('#errore').hide()
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                sweet('Peringatan!!!', thrownError, 'warning', 'warning')
            }
        });
        return false
    }
})
function searchFilterKonsumen(page_num) {
    page_num = page_num ? page_num : 0;
    var keywords = $('#keywords').val(),
    sortBy = $('#sortBy').val(),
    limits = $('#limits').val(),
    urlnya = base_url + "konsumen/ajaxKonsumen/" + page_num;
    $.ajax({
        type: 'POST',
        url: urlnya,
        data: {
            page: page_num,
            keywords: keywords,
            sortBy: sortBy,
            limits: limits
        },
        beforeSend: function () {
            gload("show")
        },
        success: function (html) {
            $('#dataListKonsumen').html(html);
            gload('hide')
        },
        error: function (xhr, status, error) {
            var err = xhr.responseText;
            sweet('Server!!!', err, 'error', 'danger');
            gload('hide')
        }
    })
};
$(document).on('click', '.edit_konsumen', function (e) {
    e.preventDefault();
    load_jenis_lembaga('edit');
    var dataID = $(this).attr('data-id');
    $.ajax({
        url: base_url + 'konsumen/cek_konsumen',
        data: {
            id: dataID
        },
        method: 'POST',
        dataType: 'json',
        beforeSend: function () {
            gload('show')
        },
        success: function (data) {
            if (data.status == 200) {
                if (level != 'admin')
                    $('.update_data').attr('disabled', true);
                if (data.jenis > 1) {
                    $('.tampil_lembaga').show()
                } else
                    $('.tampil_lembaga').hide();
                $('#modal-edit-konsumen').modal({
                    backdrop: 'static',
                    keyboard: false
                });
                $('#error_piutang').css('display', 'none');
                $("#id_edit").val(data.id);
                $("#panggilan_edit").val(data.panggilan);
                $("#telepon_edit").val(data.nohp);
                $("#nama_edit").val(data.nama);
                $("#alamat_edit").val(data.alamat1);
                $("#jenis_lembaga_edit").val(data.jenis);
                $("#nama_perusahaan_edit").val(data.perusahaan);
                $("#alamat_perusahaan_edit").val(data.alamat2);
                $("#no_telp_edit").val(data.no_telp);
                $("#via_edit").val(data.via);
                $("#tampil_edit").val(data.tampil);
                $("#status").val(data.status);
                $("#max_u").val(data.max);
                gload('hide')
            } else if (data.status == 401) {
                sweet('Login Status!!!', data.msg, 'error', 'danger');
                gload('hide')
            }
        },
        error: function (xhr, status, error) {
            var err = xhr.responseText;
            sweet('Server!!!', err, 'error', 'danger');
            gload('hide')
        }
    })
});
$("#status_add").change(function () {
    var id = $("#status_add").val();
    if (id == 1) {
        $("#max_u_add").prop("readonly", true)
    } else
        $("#max_u_add").prop("readonly", false)
});
$("#status").change(function () {
    var id = $("#status").val();
    if (id == 1) {
        $("#max_u").prop("readonly", true)
    } else
        $("#max_u").prop("readonly", false)
});
$(document).on('click', '.batal_order', function (e) {
    e.preventDefault();
    var dataID = $(this).attr('data-id'),
    mod = $(this).data('modedit');
    $.ajax({
        url: base_url + 'main/cek_order',
        data: {
            id: dataID
        },
        method: 'POST',
        dataType: 'json',
        success: function (data) {
            $("#no_order").val("");
            $("#keterangan").val("");
            if (data.status == 'ok') {
                $('#modal-batal').modal('show');
                $("#no_order").val(data.id);
                $("#keterangan").val(data.ket);
                $("#mod_batal").val(mod);
                $("#total_batal").val(formatMoney(data.total, 0, "Rp."));
                load_jenis_batal()
            } else
                sweet('Status!!!', data.msg, 'warning', 'warning')
        },
        error: function (xhr, status, error) {
            var err = xhr.responseText;
            sweet('Server!!!', err, 'error', 'danger')
        }
    })
});
$('#OpenCart-1').on('hide.bs.modal', function () {
    $("#print,#bayarin,#simpan").prop("disabled", false);
    $("#namanya").html('');
    hideCart();
    searchFilter();
    $.LoadingOverlay("hide")
});
$('#print-4').on('hide.bs.modal', function () {
    searchFilter();
    $.LoadingOverlay("hide")
})
function resetForm() {
    $('#dispu').html('');
    $('#telepon_add').focus();
    $("#form-tambah").trigger("reset");
    $('#panggilan_add,#nama_add,#telepon_add,#alamat_add,#perusahaan_add,#jenis_lembaga_add,#alamat_perusahaan_add,#no_telp_add,#tampil_data,#via_add,#save-cari,#status_add,#max_u_add').prop('disabled', false)
};
$('body').on('hidden.bs.modal', '.modal', function () {
    $(this).removeData('bs.modal');
    $(this).find('form').trigger('reset');
    $.LoadingOverlay("hide")
});
$('#modal-batal').on('hidden.bs.modal', function (e) {
    e.preventDefault();
    $(this).find("input,textarea,select").val('').end().find("input[type=checkbox], input[type=radio]").prop("checked", "").end()
});
$("#form-batal").submit(function (e) {
    e.preventDefault();
    var saldo = angka($("#saldo_kas_batal").val()),
    sumber = angka($("#sumber_kas_batal").val());
    if (parseInt(saldo) <= 0 && sumber != 211) {
        sweet('Peringatan!!!', 'Saldo tidak mencukupi', 'warning', 'warning');
        return
    };
    var dataform = $("#form-batal").serialize();
    $.ajax({
        url: base_url + "main/simpan_batal",
        type: "post",
        data: dataform,
        dataType: 'json',
        success: function (arr) {
            if (arr.ok == "ok") {
                sweet('Update!!!', arr.msg, 'success', 'success')
            } else
                sweet('Peringatan!!!', arr.msg, 'warning', 'warning');
            searchFilter();
            $('#modal-batal').modal('hide');
            $('#OpenCart-1').modal('hide')
        },
        error: function (xhr, status, error) {
            var err = xhr.responseText;
            sweet('Server!!!', err, 'error', 'danger');
            $('#modal-batal').modal('hide');
            $('#OpenCart-1').modal('hide')
        }
    })
});
$("#form-edit-k").submit(function (e) {
    e.preventDefault();
    var dataform = $("#form-edit-k").serialize();
    $.ajax({
        url: base_url + "konsumen/update_konsumen",
        type: "post",
        data: dataform,
        dataType: 'json',
        beforeSend: function () {
            gload('show')
        },
        success: function (arr) {
            if (arr.status == 200) {
                sweet('Update!!!', arr.msg, 'success', 'arr.ok');
                searchFilterKonsumen()
            } else
                sweet('Peringatan!!!', arr.msg, 'warning', 'warning');
            $('#modal-edit-konsumen').modal('hide');
            gload('hide')
        },
        error: function (xhr, status, error) {
            var err = xhr.responseText;
            sweet('Server!!!', err, 'error', 'danger');
            $('#modal-edit-konsumen').modal('hide');
            gload('hide')
        }
    })
})
